# Mosquitto MQTT 브로커 설정 파일 (Let's Encrypt TLS 적용)

# ============== 기본 설정 ==============
# 브로커가 메시지를 디스크에 저장하여 재시작 후에도 유지되도록 합니다.
persistence true
persistence_location /mosquitto/data/ # 컨테이너 내부의 데이터 저장 경로

# 로그 레벨을 디버그로 설정하여 상세한 로그를 볼 수 있도록 합니다.
log_type debug
log_timestamp true # 로그에 타임스탬프를 포함합니다.

# ============== 리스너 설정 ==============
# 일반 MQTT 포트 1883은 비활성화합니다. (보안 강화를 위해 TLS만 사용)
# listener 1883 0.0.0.0

# TLS/SSL 암호화된 MQTT 포트 (표준 8883)
listener 8883 0.0.0.0

# TLS 설정: Let's Encrypt 인증서 경로 지정 (컨테이너 내부 경로)
# 이 경로들은 Docker run 명령어에서 VM의 /etc/letsencrypt/live/www.sapaghetti.shop/ 경로를
# 컨테이너 내부의 /mosquitto/config/certs/letsencrypt/ 경로로 마운트했을 때 유효합니다.
cafile /mosquitto/config/certs/letsencrypt/chain.pem
certfile /mosquitto/config/certs/letsencrypt/fullchain.pem
keyfile /mosquitto/config/certs/letsencrypt/privkey.pem

# TLS 버전 설정 (권장: TLSv1.2 이상)
tls_version tlsv1.2

# 클라이언트 인증서 검증 (Mutual TLS) - 선택 사항
# false로 설정하면 클라이언트 인증서가 없어도 연결은 허용합니다.
require_certificate false

# ============== 인증 설정 ==============
# TLS 포트 사용 시 allow_anonymous를 false로 설정하여 보안 강화 권장.
# 하지만 테스트를 위해 일단 true로 유지합니다.
allow_anonymous true

# ============== 웹소켓 리스너 설정 (선택 사항) ==============
# 웹 기반 클라이언트(예: JavaScript)가 MQTT 브로커에 연결할 수 있도록 하는 포트입니다.
listener 9001
protocol websockets
# 웹소켓에도 TLS를 적용하려면 여기에도 cafile, certfile, keyfile을 추가해야 합니다.
# cafile /mosquitto/config/certs/letsencrypt/chain.pem
# certfile /mosquitto/config/certs/letsencrypt/fullchain.pem
# keyfile /mosquitto/config/certs/letsencrypt/privkey.pem
